<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Townly - Investor Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* Navigation */
        .navbar {
            background-color: #fff;
            padding: 1.2rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #555;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #3498db;
        }

        .nav-links a.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-create {
            padding: 0.6rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #3498db;
            color: white;
        }

        .btn-create:hover {
            background-color: #2980b9;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 1rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stat-change.positive {
            color: #27ae60;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        .stat-subtext {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .chart-header {
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-subtitle {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Holdings Grid */
        .holdings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .section-header {
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .holding-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .holding-card:hover {
            transform: translateY(-5px);
        }

        .holding-image {
            height: 200px;
            width: 100%;
            object-fit: cover;
        }

        .holding-content {
            padding: 1.5rem;
        }

        .holding-header {
            margin-bottom: 1rem;
        }

        .holding-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .holding-location {
            color: #7f8c8d;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .holding-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .holding-stat {
            text-align: center;
        }

        .holding-stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.3rem;
        }

        .holding-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .holding-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .holding-type {
            padding: 0.3rem 0.8rem;
            background: #f0f7ff;
            color: #3498db;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .holding-risk {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .risk-low {
            color: #27ae60;
        }

        .risk-moderate {
            color: #f39c12;
        }

        .risk-high {
            color: #e74c3c;
        }

        /* Properties Grid */
        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .property-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .property-card:hover {
            transform: translateY(-5px);
        }

        .property-image {
            height: 180px;
            width: 100%;
            object-fit: cover;
        }

        .property-content {
            padding: 1.5rem;
        }

        .property-header {
            margin-bottom: 1rem;
        }

        .property-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .property-location {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .property-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .property-stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .property-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .property-progress {
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
        }

        .property-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .property-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .property-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-view,
        .btn-edit {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .btn-edit {
            background: #f8f9fa;
            color: #555;
            border: 1px solid #ddd;
        }

        /* Create Property Card */
        .create-property-card {
            background: white;
            border-radius: 12px;
            border: 2px dashed #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .create-property-card:hover {
            border-color: #3498db;
            background: #f0f7ff;
        }

        .create-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 1rem;
        }

        .create-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .create-subtext {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .nav-links {
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }

            .header-actions {
                margin-top: 1rem;
                width: 100%;
            }

            .container {
                padding: 1rem;
            }

            .stats-grid,
            .holdings-grid,
            .properties-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid #3498db;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast.success .toast-icon {
            color: #27ae60;
        }

        .toast.error .toast-icon {
            color: #e74c3c;
        }

        .toast.warning .toast-icon {
            color: #f39c12;
        }

        .toast.info .toast-icon {
            color: #3498db;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .toast-message {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .toast-close {
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            font-size: 1.2rem;
        }
    </style>
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <a href="marketplace.html" class="logo">Townly</a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="marketplace.html">Marketplace</a>
            <a href="#" class="active">Portfolio</a>
            <a href="dashboard.html">Dashboard</a>
            <div class="header-actions">
                <button class="btn-create" onclick="createNewProperty()">
                    <i class="fas fa-plus"></i> Create Property
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Investor Portfolio</h1>
            <p class="page-subtitle">Track and manage your real-world asset investments</p>
        </div>

        <!-- Portfolio Overview -->
        <div class="stats-grid">
            <div class="stat-card" id="totalInvestedCard">
                <div class="stat-header">
                    <div class="stat-title">TOTAL INVESTED</div>
                    <div class="stat-change" id="portfolioPercentage"></div>
                </div>
                <div class="stat-value" id="totalInvestedEth">0.0000 ETH</div>
                <div class="stat-subtext" id="portfolioValueText">0% of portfolio value</div>
            </div>

            <div class="stat-card" id="currentValueCard">
                <div class="stat-header">
                    <div class="stat-title">CURRENT VALUE</div>
                    <div class="stat-change positive" id="valueChangePercent">+0.00%</div>
                </div>
                <div class="stat-value" id="currentValueEth">0.0000 ETH</div>
                <div class="stat-subtext" id="valueChangeText">+0.00% of portfolio value</div>
            </div>

            <div class="stat-card" id="totalReturnsCard">
                <div class="stat-header">
                    <div class="stat-title">TOTAL RETURNS</div>
                </div>
                <div class="stat-value" id="totalReturnEth">+0.0000 ETH</div>
                <div class="stat-subtext" id="totalReturnText">Passed 0 ETH</div>
            </div>

            <div class="stat-card" id="monthlyIncomeCard">
                <div class="stat-header">
                    <div class="stat-title">MONTHLY INCOME</div>
                </div>
                <div class="stat-value" id="monthlyIncomeEth">0.0000 ETH</div>
                <div class="stat-subtext" id="nextPaymentDate">Next payment: --</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <!-- Portfolio Value Trend Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Portfolio Value Trend</h3>
                    <p class="chart-subtitle">Last 7 months performance</p>
                </div>
                <div class="chart-container">
                    <canvas id="portfolioTrendChart"></canvas>
                </div>
            </div>

            <!-- Holdings by Category Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Holdings by Category</h3>
                    <p class="chart-subtitle">Distribution across property types</p>
                </div>
                <div class="chart-container">
                    <canvas id="holdingsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Final Risk Score -->
        <div class="chart-card" style="margin-bottom: 2rem;">
            <div class="chart-header">
                <h3 class="chart-title">Portfolio Risk Score</h3>
                <p class="chart-subtitle">Overall risk assessment of your investments</p>
            </div>
            <div class="risk-score-display">
                <div class="stat-value" id="riskScoreValue">0.0/10</div>
                <div class="stat-subtext" id="riskLevelText">Calculating risk level...</div>
                <div style="margin-top: 1rem; height: 10px; background: #eee; border-radius: 5px; overflow: hidden;">
                    <div id="riskScoreBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c); transition: width 1s ease;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #7f8c8d;">
                    <span>Low Risk</span>
                    <span>Moderate</span>
                    <span>High Risk</span>
                </div>
            </div>
        </div>

        <!-- Your Property Holdings Section -->
        <div class="section-header">
            <h2 class="section-title">Your Property Holdings</h2>
            <p class="chart-subtitle">Active tokenized/renting holdings</p>
        </div>

        <div class="holdings-grid" id="holdingsContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading your holdings...</p>
            </div>
        </div>

        <!-- My Listed Properties Section -->
        <div class="section-header">
            <h2 class="section-title">My Listed Properties</h2>
            <p class="chart-subtitle">Properties you've owned and tokenized</p>
        </div>

        <div class="properties-grid" id="propertiesContainer">
            <!-- Properties will be loaded here -->
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading your properties...</p>
            </div>

            <!-- Create New Property Card -->
            <div class="create-property-card" onclick="createNewProperty()">
                <div class="create-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="create-text">Create New Property</div>
                <div class="create-subtext">Click to list a new property</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:5168';
        const ETH_TO_USD = 2000; // Current ETH to USD rate (from your investment data)
        const CURRENT_MONTH = "Apr"; // Current month for display

        // DOM Elements
        const holdingsContainer = document.getElementById('holdingsContainer');
        const propertiesContainer = document.getElementById('propertiesContainer');
        const toastContainer = document.getElementById('toastContainer');
        
        // Portfolio overview elements
        const totalInvestedEth = document.getElementById('totalInvestedEth');
        const currentValueEth = document.getElementById('currentValueEth');
        const totalReturnEth = document.getElementById('totalReturnEth');
        const monthlyIncomeEth = document.getElementById('monthlyIncomeEth');
        const portfolioPercentage = document.getElementById('portfolioPercentage');
        const portfolioValueText = document.getElementById('portfolioValueText');
        const valueChangePercent = document.getElementById('valueChangePercent');
        const valueChangeText = document.getElementById('valueChangeText');
        const totalReturnText = document.getElementById('totalReturnText');
        const nextPaymentDate = document.getElementById('nextPaymentDate');
        const riskScoreValue = document.getElementById('riskScoreValue');
        const riskLevelText = document.getElementById('riskLevelText');
        const riskScoreBar = document.getElementById('riskScoreBar');

        // Charts
        let portfolioTrendChart = null;
        let holdingsChart = null;

        // State
        let portfolioOverview = null;
        let investments = [];
        let portfolioAllocation = [];
        let portfolioLineData = [];
        let userProperties = [];

        // Format number with commas
        function formatNumber(num) {
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Format ETH with 4 decimals
        function formatETH(eth) {
            return parseFloat(eth).toFixed(4) + ' ETH';
        }

        // Format USD
        function formatUSD(usd) {
            return '$' + formatNumber(usd);
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Show toast notification
        function showToast(type, title, message, duration = 5000) {
            const toastId = 'toast-' + Date.now();
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icons[type]}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (document.getElementById(toastId)) {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
        }

        // Get authorization headers
        function getAuthHeaders() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                // Redirect to login if no token
                window.location.href = 'index.html';
                return {};
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // Check if user is logged in
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            const expires = localStorage.getItem('token_expires');
            
            if (!token || !expires) {
                window.location.href = 'index.html';
                return false;
            }
            
            const expiryDate = new Date(expires);
            if (expiryDate <= new Date()) {
                localStorage.clear();
                window.location.href = 'index.html';
                return false;
            }
            
            return true;
        }

        // Fetch portfolio overview
        async function fetchPortfolioOverview() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/portfolio/me/overview`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired
                        localStorage.clear();
                        window.location.href = 'index.html';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to fetch portfolio overview`);
                }
                
                portfolioOverview = await response.json();
                updatePortfolioOverview();
                
            } catch (error) {
                console.error('Error fetching portfolio overview:', error);
                showToast('error', 'Error', 'Failed to load portfolio overview');
            }
        }

        // Fetch investments
        async function fetchInvestments() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/investments/me`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to fetch investments`);
                }
                
                investments = await response.json();
                renderHoldings();
                calculateRiskScore();
                
            } catch (error) {
                console.error('Error fetching investments:', error);
                showToast('error', 'Error', 'Failed to load investments');
            }
        }

        // Fetch portfolio allocation
        async function fetchPortfolioAllocation() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/analytics/portfolio/me/allocation`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to fetch portfolio allocation`);
                }
                
                portfolioAllocation = await response.json();
                renderHoldingsChart();
                
            } catch (error) {
                console.error('Error fetching portfolio allocation:', error);
                showToast('error', 'Error', 'Failed to load portfolio allocation');
            }
        }

        // Fetch portfolio line data
        async function fetchPortfolioLineData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/analytics/portfolio/me/line`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to fetch portfolio trend`);
                }
                
                portfolioLineData = await response.json();
                renderPortfolioTrendChart();
                
            } catch (error) {
                console.error('Error fetching portfolio line data:', error);
                // Use mock data for now
                portfolioLineData = generateMockTrendData();
                renderPortfolioTrendChart();
                showToast('warning', 'Note', 'Using demo data for portfolio trend');
            }
        }

        // Fetch user properties
        async function fetchUserProperties() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/properties/me`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to fetch properties`);
                }
                
                userProperties = await response.json();
                renderProperties();
                
            } catch (error) {
                console.error('Error fetching user properties:', error);
                showToast('error', 'Error', 'Failed to load your properties');
            }
        }

        // Generate mock trend data for demo
        function generateMockTrendData() {
            const months = ['Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', CURRENT_MONTH];
            const baseValue = 1000;
            
            return months.map((month, index) => {
                const growth = Math.pow(1.1, index); // 10% growth each month
                const randomFactor = 0.95 + Math.random() * 0.1; // Random factor between 0.95 and 1.05
                const value = baseValue * growth * randomFactor;
                
                return {
                    label: month,
                    value: value * ETH_TO_USD // Convert to USD for consistency with API
                };
            });
        }

        // Update portfolio overview UI
        function updatePortfolioOverview() {
            if (!portfolioOverview) return;

            totalInvestedEth.textContent = formatETH(portfolioOverview.totalInvestedEth);
            currentValueEth.textContent = formatETH(portfolioOverview.currentValueEth);
            totalReturnEth.textContent = formatETH(portfolioOverview.totalReturnEth);
            monthlyIncomeEth.textContent = formatETH(portfolioOverview.monthlyIncomeEth);

            // Calculate percentages
            const portfolioPercent = portfolioOverview.totalInvestedEth > 0 
                ? (portfolioOverview.totalInvestedEth / portfolioOverview.currentValueEth * 100).toFixed(1)
                : 0;
            
            portfolioPercentage.textContent = `${portfolioPercent}%`;
            portfolioValueText.textContent = `${portfolioPercent}% of portfolio value`;

            // Value change
            const valueChangePercentValue = portfolioOverview.totalReturnPercent || 0;
            const isPositive = valueChangePercentValue >= 0;
            
            valueChangePercent.textContent = `${isPositive ? '+' : ''}${valueChangePercentValue.toFixed(2)}%`;
            valueChangePercent.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
            valueChangeText.textContent = `${isPositive ? '+' : ''}${valueChangePercentValue.toFixed(2)}% of portfolio value`;

            // Total returns text
            const passedThreshold = Math.floor(portfolioOverview.currentValueEth / 1000) * 1000;
            totalReturnText.textContent = `Passed ${formatNumber(passedThreshold)} ETH`;

            // Next payment date (next month 1st)
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const formattedDate = nextMonth.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            nextPaymentDate.textContent = `Next payment: ${formattedDate}`;
        }

        // Calculate portfolio risk score
        function calculateRiskScore() {
            if (investments.length === 0) return;

            // Group investments by property
            const propertyInvestments = {};
            investments.forEach(investment => {
                if (!propertyInvestments[investment.propertyId]) {
                    propertyInvestments[investment.propertyId] = {
                        totalEth: 0,
                        riskScore: 7.5 // Default risk score if not available
                    };
                }
                propertyInvestments[investment.propertyId].totalEth += investment.ethAmountAtExecution;
            });

            // Calculate weighted average risk score
            let totalEth = 0;
            let weightedRiskSum = 0;

            // We need property risk scores from userProperties or use default
            const propertyRiskScores = {};
            userProperties.forEach(property => {
                propertyRiskScores[property.id] = property.riskScore || 7.5;
            });

            Object.entries(propertyInvestments).forEach(([propertyId, data]) => {
                const riskScore = propertyRiskScores[propertyId] || data.riskScore;
                weightedRiskSum += data.totalEth * riskScore;
                totalEth += data.totalEth;
            });

            const averageRiskScore = totalEth > 0 ? weightedRiskSum / totalEth : 7.5;
            updateRiskScoreDisplay(averageRiskScore);
        }

        // Update risk score display
        function updateRiskScoreDisplay(score) {
            riskScoreValue.textContent = `${score.toFixed(1)}/10`;
            
            // Update risk level text
            let riskLevel, riskClass;
            if (score <= 3) {
                riskLevel = 'Low Risk';
                riskClass = 'risk-low';
            } else if (score <= 6) {
                riskLevel = 'Low Moderate Risk';
                riskClass = 'risk-moderate';
            } else if (score <= 8) {
                riskLevel = 'Moderate Risk';
                riskClass = 'risk-moderate';
            } else {
                riskLevel = 'High Risk';
                riskClass = 'risk-high';
            }
            
            riskLevelText.textContent = riskLevel;
            riskLevelText.className = riskClass;
            
            // Update progress bar
            const percentage = (score / 10) * 100;
            riskScoreBar.style.width = `${percentage}%`;
        }

        // Render holdings (investments)
        function renderHoldings() {
            if (investments.length === 0) {
                holdingsContainer.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-info-circle"></i>
                        <p>No investments found. Start investing in the marketplace!</p>
                    </div>
                `;
                return;
            }

            // Group investments by property
            const propertyHoldings = {};
            investments.forEach(investment => {
                if (!propertyHoldings[investment.propertyId]) {
                    propertyHoldings[investment.propertyId] = {
                        propertyName: investment.propertyName,
                        propertyImageUrl: investment.propertyImageUrl,
                        location: investment.location,
                        totalEthInvested: 0,
                        totalShares: 0,
                        latestInvestment: investment.investedAt
                    };
                }
                propertyHoldings[investment.propertyId].totalEthInvested += investment.ethAmountAtExecution;
                propertyHoldings[investment.propertyId].totalShares += investment.sharesPurchased;
            });

            holdingsContainer.innerHTML = '';
            
            Object.values(propertyHoldings).forEach(holding => {
                // Calculate current value (assuming 3.33% growth as in the design)
                const currentValue = holding.totalEthInvested * 1.0333;
                const currentYield = currentValue - holding.totalEthInvested;
                
                const holdingCard = document.createElement('div');
                holdingCard.className = 'holding-card';
                holdingCard.innerHTML = `
                    <img src="${buildImageUrl(holding.propertyImageUrl)}" alt="${holding.propertyName}" class="holding-image">
                    <div class="holding-content">
                        <div class="holding-header">
                            <h3 class="holding-name">${holding.propertyName}</h3>
                            <div class="holding-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${holding.location}</span>
                            </div>
                        </div>
                        <div class="holding-stats">
                            <div class="holding-stat">
                                <div class="holding-stat-label">Total Invested</div>
                                <div class="holding-stat-value">${holding.totalEthInvested.toFixed(4)} ETH</div>
                            </div>
                            <div class="holding-stat">
                                <div class="holding-stat-label">Current Yield</div>
                                <div class="holding-stat-value">${currentYield.toFixed(4)} ETH</div>
                            </div>
                            <div class="holding-stat">
                                <div class="holding-stat-label">Current Value</div>
                                <div class="holding-stat-value">${currentValue.toFixed(4)} ETH</div>
                            </div>
                            <div class="holding-stat">
                                <div class="holding-stat-label">Shares</div>
                                <div class="holding-stat-value">${formatNumber(holding.totalShares)}</div>
                            </div>
                        </div>
                        <div class="holding-footer">
                            <span class="holding-type">TOKENIZED</span>
                            <span class="holding-risk risk-moderate">3.4/10 Risk</span>
                        </div>
                    </div>
                `;
                
                holdingsContainer.appendChild(holdingCard);
            });
        }

        // Render user properties
        function renderProperties() {
            if (userProperties.length === 0) {
                propertiesContainer.innerHTML = `
                    <div class="create-property-card" onclick="createNewProperty()">
                        <div class="create-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="create-text">Create New Property</div>
                        <div class="create-subtext">Click to list a new property</div>
                    </div>
                `;
                return;
            }

            propertiesContainer.innerHTML = '';
            
            userProperties.forEach(property => {
                const investmentProgress = ((property.totalUnits - property.availableUnits) / property.totalUnits) * 100;
                const currentValue = property.totalUnits * property.pricePerUnitEth;
                
                const propertyCard = document.createElement('div');
                propertyCard.className = 'property-card';
                propertyCard.innerHTML = `
                    <img src="${buildImageUrl(property.imageUrl)}" alt="${property.name}" class="property-image">
                    <div class="property-content">
                        <div class="property-header">
                            <h3 class="property-name">${property.name}</h3>
                            <div class="property-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${property.location}</span>
                            </div>
                        </div>
                        <div class="property-stats">
                            <div class="property-stat">
                                <div class="property-stat-label">Valuation</div>
                                <div class="property-stat-value">${formatUSD(property.approvedValuation)}</div>
                            </div>
                            <div class="property-stat">
                                <div class="property-stat-label">Yield</div>
                                <div class="property-stat-value">${property.annualYieldPercent}%</div>
                            </div>
                            <div class="property-stat">
                                <div class="property-stat-label">Units</div>
                                <div class="property-stat-value">${formatNumber(property.totalUnits)}</div>
                            </div>
                            <div class="property-stat">
                                <div class="property-stat-label">Available</div>
                                <div class="property-stat-value">${formatNumber(property.availableUnits)}</div>
                            </div>
                        </div>
                        <div class="property-progress">
                            <div class="property-stat-label">Investment Progress</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${investmentProgress}%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #7f8c8d; margin-top: 0.3rem;">
                                <span>${investmentProgress.toFixed(1)}% funded</span>
                                <span>${formatNumber(property.totalAmountInvestedUsd)} USD</span>
                            </div>
                        </div>
                        <div class="property-footer">
                            <div class="property-price">${property.pricePerUnitEth.toFixed(4)} ETH/unit</div>
                            <div class="property-actions">
                                <button class="btn-view" onclick="viewProperty('${property.id}')">View</button>
                                <button class="btn-edit" onclick="editProperty('${property.id}')">Edit</button>
                            </div>
                        </div>
                    </div>
                `;
                
                propertiesContainer.appendChild(propertyCard);
            });

            // Add Create New Property card at the end
            const createCard = document.createElement('div');
            createCard.className = 'create-property-card';
            createCard.onclick = createNewProperty;
            createCard.innerHTML = `
                <div class="create-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="create-text">Create New Property</div>
                <div class="create-subtext">Click to list a new property</div>
            `;
            propertiesContainer.appendChild(createCard);
        }

        // Build image URL
        function buildImageUrl(imageUrl) {
            if (!imageUrl) {
                return 'https://via.placeholder.com/400x200?text=No+Image';
            }
            
            if (imageUrl.startsWith('http')) {
                return imageUrl;
            }
            
            if (imageUrl.startsWith('/')) {
                return `${API_BASE_URL}${imageUrl}`;
            }
            
            return `${API_BASE_URL}/${imageUrl}`;
        }

        // Render portfolio trend chart
        function renderPortfolioTrendChart() {
            const ctx = document.getElementById('portfolioTrendChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (portfolioTrendChart) {
                portfolioTrendChart.destroy();
            }
            
            const labels = portfolioLineData.map(item => item.label);
            const values = portfolioLineData.map(item => item.value / ETH_TO_USD); // Convert USD to ETH
            
            portfolioTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Value (ETH)',
                        data: values,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(4)} ETH`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + ' ETH';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render holdings chart
        function renderHoldingsChart() {
            const ctx = document.getElementById('holdingsChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (holdingsChart) {
                holdingsChart.destroy();
            }
            
            // Process allocation data (combine similar categories)
            const categoryMap = {};
            portfolioAllocation.forEach(item => {
                const category = item.category;
                if (!categoryMap[category]) {
                    categoryMap[category] = 0;
                }
                categoryMap[category] += item.percentage;
            });
            
            const categories = Object.keys(categoryMap);
            const percentages = Object.values(categoryMap);
            
            // Colors for pie chart
            const backgroundColors = [
                '#3498db', // Residential
                '#2ecc71', // Commercial
                '#9b59b6', // Industrial
                '#f39c12', // Land
                '#e74c3c', // Other
            ];
            
            holdingsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: percentages,
                        backgroundColor: backgroundColors.slice(0, categories.length),
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Create new property
        function createNewProperty() {
            if (!checkAuth()) return;
            
            // Redirect to property creation page
            window.location.href = 'create-property.html';
        }

        // View property
        function viewProperty(propertyId) {
            if (!checkAuth()) return;
            
            // Redirect to property details page
            window.location.href = `property-details.html?id=${propertyId}`;
        }

        // Edit property
        function editProperty(propertyId) {
            if (!checkAuth()) return;
            
            // Redirect to property edit page
            window.location.href = `edit-property.html?id=${propertyId}`;
        }

        // Initialize everything
        async function initializePortfolio() {
            if (!checkAuth()) return;
            
            try {
                // Fetch all data in parallel
                await Promise.all([
                    fetchPortfolioOverview(),
                    fetchInvestments(),
                    fetchPortfolioAllocation(),
                    fetchPortfolioLineData(),
                    fetchUserProperties()
                ]);
                
                showToast('success', 'Portfolio Loaded', 'Your portfolio data has been loaded successfully', 3000);
                
            } catch (error) {
                console.error('Error initializing portfolio:', error);
                showToast('error', 'Error', 'Failed to load portfolio data');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePortfolio);
    </script>
</body>
</html>